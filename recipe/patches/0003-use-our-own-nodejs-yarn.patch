From 950199a71f5b069c4daac040b362f9c8335a9f0d Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Wed, 30 Oct 2024 15:06:02 +1100
Subject: [PATCH 3/3] use our own nodejs & yarn

---
 src/node/CMakeNodeTools.txt | 44 +++++--------------------------------
 1 file changed, 6 insertions(+), 38 deletions(-)

diff --git a/src/node/CMakeNodeTools.txt b/src/node/CMakeNodeTools.txt
index c4d152c5eb..434952509c 100644
--- a/src/node/CMakeNodeTools.txt
+++ b/src/node/CMakeNodeTools.txt
@@ -17,51 +17,26 @@ if(RSTUDIO_CMAKE_NODE_TOOLS_INCLUDED)
 endif()
 set(RSTUDIO_CMAKE_NODE_TOOLS_INCLUDED YES)
 
-# set the node version
-if(NOT DEFINED RSTUDIO_NODE_VERSION)
-   set(RSTUDIO_NODE_VERSION "20.14.0")
-endif()
-if(DEFINED ENV{RSTUDIO_NODE_VERSION})
-   set(RSTUDIO_NODE_VERSION $ENV{RSTUDIO_NODE_VERSION})
-endif()
-
 # set cmake env vars for node (NODEJS) and node tools, like YARN, and NPM
 
-if(APPLE AND UNAME_M STREQUAL arm64)
-
-   # make sure we're using arm64 binaries of node / npm for arm64 builds
-   set(NODEJS 
-      "${CMAKE_CURRENT_LIST_DIR}/../../dependencies/common/node/${RSTUDIO_NODE_VERSION}-arm64/bin/node")
-   set(NPM 
-      "${CMAKE_CURRENT_LIST_DIR}/../../dependencies/common/node/${RSTUDIO_NODE_VERSION}-arm64/bin/npm")
-   set(NPX 
-      "${CMAKE_CURRENT_LIST_DIR}/../../dependencies/common/node/${RSTUDIO_NODE_VERSION}-arm64/bin/npx")
-
-else()
-
+if(TRUE)
    # Detect node.js, npm, and npx; use versions supplied by the dependency scripts
    find_program(NODEJS
       NAMES node
       NO_DEFAULT_PATH PATH_SUFFIXES "bin"
-      PATHS "/opt/rstudio-tools/dependencies/common/node/${RSTUDIO_NODE_VERSION}"
-      "c:/rstudio-tools/dependencies/common/node/${RSTUDIO_NODE_VERSION}"
-      "${CMAKE_CURRENT_LIST_DIR}/../../dependencies/common/node/${RSTUDIO_NODE_VERSION}")
+      PATHS "$ENV{BUILD_PREFIX}")
 
    find_program(NPM
       NAMES npm
       PATH_SUFFIXES "bin"
       NO_DEFAULT_PATH 
-      PATHS "/opt/rstudio-tools/dependencies/common/node/${RSTUDIO_NODE_VERSION}"
-      "c:/rstudio-tools/dependencies/common/node/${RSTUDIO_NODE_VERSION}"
-      "${CMAKE_CURRENT_LIST_DIR}/../../dependencies/common/node/${RSTUDIO_NODE_VERSION}")
+      PATHS "$ENV{BUILD_PREFIX}")
 
    find_program(NPX
       NAMES npx
       PATH_SUFFIXES "bin"
       NO_DEFAULT_PATH 
-      PATHS "/opt/rstudio-tools/dependencies/common/node/${RSTUDIO_NODE_VERSION}"
-      "c:/rstudio-tools/dependencies/common/node/${RSTUDIO_NODE_VERSION}"
-      "${CMAKE_CURRENT_LIST_DIR}/../../dependencies/common/node/${RSTUDIO_NODE_VERSION}")
+      PATHS "$ENV{BUILD_PREFIX}")
 
 endif()
    
@@ -86,19 +61,12 @@ endif()
 get_filename_component(NODEJS_PATH ${NODEJS} DIRECTORY CACHE)
 
 # yarn
-if(UNIX)
-
-   find_program(YARN
-      NAMES yarn
-      NO_DEFAULT_PATH
-      PATHS "$ENV{HOME}/.yarn/bin")
-
-elseif(WIN32)
+if(TRUE)
 
    find_program(YARN
       NAMES yarn
       NO_DEFAULT_PATH
-      PATHS "${NODEJS_PATH}")
+      PATHS "$ENV{BUILD_PREFIX}/bin")
 
 endif()
 
